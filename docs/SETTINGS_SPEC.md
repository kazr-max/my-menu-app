# 設定画面 (Settings Page) 詳細仕様書

## 1. 画面概要
ユーザー個別のアプリケーション設定を管理する画面です。家族構成、調理器具の設定、および Google カレンダーとの連携設定を行います。ここで保存された情報は、献立生成 AI のプロンプトやカレンダー登録処理に使用されます。

## 2. 画面レイアウト・構成

画面はヘッダーと3つの主要なセクションで構成されています。

### 2.1 ヘッダー
*   **タイトル**: 「アプリ設定」
*   **戻るボタン**: トップページ (`/`) へ遷移。
*   **保存ボタン**: 現在の入力内容をデータベースに保存する。保存処理中は「保存中...」と表示され無効化される。

### 2.2 家族と食事セクション (`👪 家族と食事`)
*   **大人の人数**:
    *   数値入力フィールド。
    *   デフォルト: 2
*   **お子様の設定**:
    *   リスト形式で子供の情報を管理。
    *   **追加ボタン**: 新しい子供の入力行を追加する。
    *   **各行の構成**:
        *   **削除ボタン**: その行（子供）を削除する。
        *   **名前**: テキスト入力（任意）。
        *   **誕生日**: 日付入力 (`type="date"`)。年齢計算に使用。
        *   **食事ステージ**: セレクトボックス。以下の選択肢から選択。
            *   `離乳食完了期`
            *   `幼児食`
            *   `大人と同じ`

### 2.3 調理環境セクション (`🍳 調理環境`)
*   **ホットクック型番**:
    *   テキスト入力。
    *   例: `KN-HW24G`
*   **調理モード**:
    *   トグルボタン形式（排他選択）。
    *   選択肢: `公式優先` / `手動優先`

### 2.4 カレンダー連携セクション (`📅 カレンダー連携`)
*   **Googleアカウント**:
    *   **未ログイン時**: 「Googleでログイン」ボタンを表示。押下すると Google 認証フローを開始。
    *   **ログイン時**: ユーザーアイコン、名前、メールアドレスを表示。「解除」ボタン（ログアウト）を表示。
*   **共有カレンダーID**:
    *   テキスト入力。
    *   用途: 夫婦共有のカレンダーなど、デフォルト（primary）以外のカレンダーに予定を登録したい場合に指定。
    *   プレースホルダー: `primary または 共有カレンダーID`

## 3. データモデル (Frontend State)

画面内で管理されている状態オブジェクト (`settings`) の構造です。

```typescript
interface SettingsState {
  adults: number;
  children: {
    id: number;       // 一意なID (Date.now()で生成)
    name: string;
    birthday: string; // YYYY-MM-DD形式
    stage: '離乳食完了期' | '幼児食' | '大人と同じ';
  }[];
  dislikes: string;       // ※現状UI未実装 (コード上は存在)
  modelNumber: string;    // ホットクック型番
  cookingMode: 'official' | 'manual';
  calendarColor: string;  // ※現状UI未実装 (初期値: '#039be5')
  eventFormat: string;    // ※現状UI未実装 (初期値: '【献立】{{menuName}}')
  calendarId: string;     // カレンダーID (初期値: 'primary')
}
```

## 4. 機能仕様詳細

### 4.1 初期表示処理
*   画面ロード時に `useEffect` により `/api/settings` (GET) を呼び出す。
*   取得に成功した場合、レスポンスデータを `settings` ステートにマージして表示に反映する。
*   認証セッション (`useSession`) を取得し、ログイン状態を判定する。

### 4.2 保存処理 (`handleSave`)
*   「保存」ボタン押下時に発火。
*   `/api/settings` (POST) へ現在の `settings` オブジェクトを JSON として送信。
*   **成功時**: アラート「設定を保存しました（夫婦で共有されます）」を表示。
*   **失敗時**: アラートでエラー内容を表示。
*   **通信エラー時**: アラート「通信エラーが発生しました。」を表示。

### 4.3 認証・認可
*   NextAuth.js (`next-auth/react`) を使用。
*   Google プロバイダーによる OAuth 認証。
*   設定の保存・取得 API は、サーバーサイドでセッション（ログイン状態）をチェックしており、未ログインの場合は 401 エラーを返す仕様となっている。


