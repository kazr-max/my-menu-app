# メイン画面 (Main Page) 仕様設計書

## 1. 画面概要
アプリケーションのトップページ (`/`)。
ユーザーが指定した期間と要望に基づいて、AI が献立と買い物リストを生成する画面です。生成された献立は Google カレンダーへ一括登録できます。

## 2. 画面レイアウト・構成

### 2.1 ヘッダーエリア
*   **アプリタイトル**: 「献立アシスタント」
*   **設定情報表示**: 読み込まれた設定（ホットクック機種、子供の年齢）を簡易表示。
*   **設定リンク**: 歯車アイコン。クリックで設定画面 (`/settings`) へ遷移。

### 2.2 入力フォームエリア
*   **期間設定**:
    *   **開始日**: 日付ピッカー (`type="date"`)。デフォルトは当日。
    *   **期間**: セレクトボックス。1〜7日間から選択（デフォルト: 3日間）。
*   **要望入力**:
    *   テキストエリア。
    *   プレースホルダー: 「例：子供が喜ぶカレー、野菜多め...」
*   **アクションボタン**:
    *   **「献立案を作成する」**: AI 生成処理を開始。
    *   **「デバッグモード」**: API を使用せずダミーデータを表示（開発用）。

### 2.3 結果表示エリア
*   **カレンダー登録ボタン**:
    *   献立生成後に表示。
    *   ログイン状態であれば登録処理を実行。未ログイン時はログインを促す表示。
*   **献立カードリスト**:
    *   生成された日数分、カード形式で表示。
    *   **日付**: 開始日から順に計算して表示（例: 1/1）。
    *   **内容**: メニュー名、レシピ、手順などのテキスト。
*   **買い物リスト**:
    *   献立生成後に表示。
    *   **コピーボタン**: リストの内容をクリップボードにコピー。
*   **デバッグログ**:
    *   AI からの生の JSON レスポンスを確認するための折りたたみ表示。

## 3. データモデル (Frontend State)

```typescript
interface MainPageState {
  // 入力系
  startDate: string;      // YYYY-MM-DD
  duration: number;       // 生成日数 (1-7)
  freeInput: string;      // ユーザーの要望テキスト

  // データ系
  settings: any;          // /api/settings から取得したユーザー設定
  recipes: string[];      // 生成された献立リスト（各要素が1日分のテキスト）
  shoppingList: string;   // 生成された買い物リスト

  // UI状態
  loading: boolean;       // 献立生成中フラグ
  registering: boolean;   // カレンダー登録中フラグ
  debugLog: string;       // デバッグ用生ログ
}
```

## 4. 機能仕様詳細

### 4.1 初期化処理
*   **日付設定**: クライアントサイドでのハイドレーションエラーを防ぐため、`useEffect` で当日の日付を `startDate` に設定。
*   **設定取得**: `useEffect` で `GET /api/settings` を呼び出し、ホットクック型番や家族構成を取得。
    *   **重要**: 取得に失敗した場合（未ログインや通信エラー）、仮のデータ（デフォルト値）は設定しない。`settings` は `null` のまま維持し、未設定状態とする。

### 4.2 献立生成 (`generateMenu`)
1.  **バリデーション**:
    *   設定情報 (`settings`) が未取得の場合は、**処理を即座に中断**する。
    *   アラートを表示し、設定画面への遷移またはログインを促す（機能を利用させない）。
2.  **プロンプト構築**:
    *   設定情報（機種、子供の年齢）、期間、要望を組み込む。
    *   **出力制約**: JSON形式のみを返すよう指示。`days` 配列と `shoppingList` 文字列を含む構造を指定。
    *   **調理要件**: 「1歳児用の取り分け手順」を含めるよう指示。
3.  **API送信**: `POST /api/chat` へリクエスト。
4.  **レスポンス処理**:
    *   返却されたテキストから Markdown 記法（```json）を除去。
    *   `JSON.parse` を実行。
    *   **救済ロジック**: AI が配列を返さず1つの文字列にまとめてしまった場合、正規表現で分割を試みる。
    *   `recipes` と `shoppingList` ステートを更新。

### 4.3 カレンダー登録 (`registerToCalendar`)
1.  **イベントデータ作成**:
    *   `recipes` の各要素に対して日付を割り当て（開始日 + index）。
    *   正規表現で「【メニュー】」部分を抽出し、カレンダーのタイトル（summary）とする。
    *   全文を詳細（description）に設定。
2.  **API送信**: `POST /api/calendar` へリクエスト。
    *   Payload: `{ events: [...], calendarId: settings.calendarId }`
3.  **完了処理**: 成功/失敗のアラートを表示。

## 5. エラーハンドリング
*   **APIエラー**: `fetch` 失敗時や非200レスポンス時はアラートを表示。
*   **JSONパースエラー**: AI の応答が JSON として不正な場合、アラートで生データを表示し、フォールバックとして生テキストをそのまま画面に表示する。